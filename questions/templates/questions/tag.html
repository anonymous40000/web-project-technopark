{% extends "questions/base.html" %}
{% load static %}

{% block title %}Tag: {{ tag_name|default:"all" }} • OlegOverFlow{% endblock %}

{% block main %}
<main class="main">
    <section class="questions">
        <div class="questions__title">
            <h2>Tag: <span id="tagTitle">{{ tag_name|default:"all" }}</span></h2>
        </div>

        <div id="list" class="questions__content">
            {% for q in questions %}
            <div class="question__root">
                <div class="question__aside">
                    <img
                        src="{{ q.author.profile.get_avatar_url }}"
                        alt="{{ q.author.username }}"
                        class="question__image"
                    >
                    <input
                        class="question__votes"
                        type="number"
                        value="{{ q.rating }}"
                        data-question-id="{{ q.id }}"
                        data-vote-url="{% url 'questions:vote_question' q.id %}"
                    >
                </div>
                <div class="question__content">
                    <h3 class="question__header">
                        <a href="{% url 'questions:question_detail' q.id %}">{{ q.name }}</a>
                    </h3>
                    <p class="question__description">{{ q.short_text }}</p>
                    <div class="question__footer">
                        <a href="{% url 'questions:question_detail' q.id %}" class="question__answers">
                            answers ({{ q.answers_count }})
                        </a>
                        <div class="question__tags">
                            <span class="question__subtitle">Tags</span>
                            <div class="question__tags__list">
                                {% for qt in q.question_tags.all %}
                                <a class="tag" href="{% url 'questions:tag' %}?tag={{ qt.tag.name }}">
                                    {{ qt.tag.name }}
                                </a>
                                {% empty %}
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="question__root">
                <div class="question__content">
                    <p>No questions found for this tag.</p>
                </div>
            </div>
            {% endfor %}
        </div>

        {% include 'questions/blocks/pagination.html' with objects=questions %}
    </section>
</main>

<script>
const params = new URLSearchParams(location.search);
const current = (params.get('tag') || '').trim();
document.getElementById('tagTitle').textContent = current || 'all';
if (!current) document.title = 'All tags • OlegOverFlow';
else document.title = `Tag: ${current} • OlegOverFlow`;

document.addEventListener('DOMContentLoaded', function () {

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    const csrftoken = getCookie('csrftoken');
    const loginUrl = "{% url 'core:login' %}";

    function attachVoteHandler(input) {
        if (!input) return;

        input.dataset.prevRating = input.value;

        input.addEventListener('change', function () {
            const voteUrl = input.dataset.voteUrl;
            if (!voteUrl) return;

            const newRating = input.value;
            const prev = input.dataset.prevRating || '0';

            fetch(voteUrl, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': csrftoken,
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({ rating: newRating }),
                credentials: 'same-origin',
            })
            .then(resp => resp.json().then(data => ({ status: resp.status, data })))
            .then(({ status, data }) => {
                if (status === 401 || data.error === 'auth_required') {
                    window.location.href = loginUrl + '?next=' + encodeURIComponent(
                        window.location.pathname + window.location.search + window.location.hash
                    );
                    return;
                }
                if (!data.ok) {
                    alert(data.error || 'Ошибка при голосовании');
                    input.value = prev;
                    return;
                }
                input.value = data.rating;
                input.dataset.prevRating = data.rating;
            })
            .catch(err => {
                console.error(err);
                alert('Ошибка сети при голосовании');
                input.value = prev;
            });
        });
    }

    document.querySelectorAll('.question__votes').forEach(attachVoteHandler);
});
</script>
{% endblock %}
